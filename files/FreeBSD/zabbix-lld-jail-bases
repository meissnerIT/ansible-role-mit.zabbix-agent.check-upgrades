#!/usr/local/bin/python3
#
# Managed by ansible (mit.zabbix-agent.check-upgrades)
# DO NOT EDIT THIS FILE BY HAND -- YOUR CHANGES WILL BE OVERWRITTEN

bastille_conf='/usr/local/etc/bastille/bastille.conf'

import json
import os
import re
import subprocess
import tomllib
from os.path import exists
from string import Template

data = list()

if exists(bastille_conf):
    with open(bastille_conf, "rb") as f:
        config = tomllib.load(f)

    releasesdir = Template(config.get('bastille_releasesdir')).substitute(config)

    ls_releasesdir = subprocess.run(['sudo', 'ls', releasesdir], capture_output=True, text=True)
    for dir in ls_releasesdir.stdout.splitlines():
    #for dir in os.listdir(bastille_releasesdir):
        data.append({
            "{#RELEASE}": dir,
            "{#ROOT}": os.path.join(releasesdir, dir)
        })

if exists('/srv/cbsd'):
    releasesdir = '/srv/cbsd/basejail'
    ls_releasesdir = subprocess.run(['ls', releasesdir], capture_output=True, text=True)
    for dir in ls_releasesdir.stdout.splitlines():
        release = re.search('[0-9]+\.[0-9]+', dir).group(0) + '-RELEASE'
        data.append({
            "{#RELEASE}": release,
            "{#ROOT}": os.path.join(releasesdir, dir)
        })

print(json.dumps({"data": data}, indent=4))

