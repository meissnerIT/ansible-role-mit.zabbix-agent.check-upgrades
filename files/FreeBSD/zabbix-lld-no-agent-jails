#!/usr/local/bin/python3
#
# Managed by ansible (mit.zabbix-agent.check-upgrades)
# DO NOT EDIT THIS FILE BY HAND -- YOUR CHANGES WILL BE OVERWRITTEN
#
# List jails with no (Zabbix) Agent installed, e.g. jails which are managed on
# host level.

import json
import re
import subprocess


def load_config(file_path):
    config = {}
    with open(file_path, "r") as f:
        for line in f:
            line = line.strip()
            if line and not line.startswith("#"):
                key, value = line.split("=", 1)
                config[key] = value.strip('\'"')
    return config


config = load_config("/usr/local/etc/zabbix/mit-zabbix-lld-no-agent-jails.conf")
pattern = re.compile(config["regexp"])

data = list()

jls = subprocess.run(["jls", "-h", "name"], capture_output=True, text=True)
for jail in jls.stdout.splitlines()[1:]:
    if pattern.match(jail):
        data.append({"{#NAME}": jail})

print(json.dumps({"data": data}, indent=4))
