#!/bin/sh
#
# Managed by ansible (mit.zabbix-agent.check-upgrades)
# DO NOT EDIT THIS FILE BY HAND -- YOUR CHANGES WILL BE OVERWRITTEN

# Initialize variables
VERBOSE=false
ZABBIX_CONFIG="/usr/local/etc/zabbix/zabbix_agentd.conf"
# Provides regexp
. /usr/local/etc/zabbix/mit-zabbix-lld-no-agent-jails.conf

# Parse arguments
if [ $# -gt 0 ] && [ "$1" = "-v" ]; then
    VERBOSE=true
fi

send_to_zabbix() {
    key=$1
    value=$2
    if [ "$VERBOSE" = true ]; then
        echo "Transmitting $key='$value'"
        zabbix_sender -c "$ZABBIX_CONFIG" -k "$key" -o "$value"
    else
        zabbix_sender -c "$ZABBIX_CONFIG" -k "$key" -o "$value" >/dev/null 2>&1
    fi
}

# $1: Name of the jail
send_audit() {
    if [ -n "$1" ]; then
        key="system.sw.upgradeable-packages.pkg-audit[$1]"
        value=$(sudo /usr/sbin/pkg -j $1 audit --fetch --raw=json --recursive --quiet)
    else
        cache_file=/var/cache/zabbix/pkg-audit$file_opt
        chmod 644 $cache_file
        key="system.sw.upgradeable-packages.pkg-audit"
        value=$(pkg audit --fetch --file $cache_file --raw=json --recursive --quiet)
    fi

    send_to_zabbix "$key" "$value"
}

# $1: Name of the jail
send_upgradeable_packages() {
    key_opt=""
    pkg=""
    if [ -n "$1" ]; then
        pkg="sudo /usr/sbin/pkg -j $1"
        key_opt="[$1]"
    else
        pkg="pkg"
    fi

    key="system.sw.upgradeable-packages.pkgs$key_opt"
    value=$($pkg upgrade --dry-run |
        egrep "^\s" | awk '{$1=$1;print}' | tr "\n" , | sed 's/,$//')

    send_to_zabbix "$key" "$value"
}

# Check host system
send_audit ""
send_upgradeable_packages ""

# Check all jails
jls -h name 2>/dev/null | tail -n +2 | grep -E "$regexp" | while read name; do
    if [ -n "$name" ]; then
        send_audit "$name"
        send_upgradeable_packages "$name"
    fi
done
