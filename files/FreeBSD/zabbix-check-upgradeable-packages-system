#!/bin/sh
#
# Managed by ansible (mit.zabbix-agent.check-upgrades)
# DO NOT EDIT THIS FILE BY HAND -- YOUR CHANGES WILL BE OVERWRITTEN

# Initialize variables
VERBOSE=false
ZABBIX_CONFIG="/usr/local/etc/zabbix/zabbix_agentd.conf"

# Parse arguments
if [ $# -gt 0 ] && [ "$1" = "-v" ]; then
    VERBOSE=true
fi

send_to_zabbix() {
    key=$1
    value=$2
    if [ "$VERBOSE" = true ]; then
        echo "Transmitting $key='$value'"
        zabbix_sender -c "$ZABBIX_CONFIG" -k "$key" -o "$value"
    else
        zabbix_sender -c "$ZABBIX_CONFIG" -k "$key" -o "$value" >/dev/null 2>&1
    fi
}

send_audit_kernel() {
    chmod 644 /var/cache/zabbix/pkg-audit
    key="system.sw.upgradeable-packages.pkg-audit-kernel"
    value=$(pkg audit --fetch --file /var/cache/zabbix/pkg-audit --raw=json --recursive --quiet $(freebsd-version -k | sed 's,^,FreeBSD-kernel-,;s,-RELEASE-p,_,;s,-RELEASE$,,'))

    send_to_zabbix "$key" "$value"
}

send_freebsd_update() {
    key="system.sw.upgradeable-packages.system"
    value=$(/usr/local/bin/sudo freebsd-update --not-running-from-cron updatesready | egrep -v "(skipped|No updates are available to install\.)")

    send_to_zabbix "$key" "$value"
}

send_audit_kernel
send_freebsd_update
